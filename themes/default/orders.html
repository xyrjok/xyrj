<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单查询</title> <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/all.min.css" rel="stylesheet">
    <link href="/themes/default/files/custom-default-bootstrap.css" rel="stylesheet">
    <style>
        body { background: #f2f2f2; }
        .order-action a { font-size: 12px; }
    </style>
</head>
<body>

    <div class="container my-4">
        <div class="row">
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 col-12">
                <div class="main-box">

                    <div class="title">
                        <i class="fas fa-file-invoice" style="color:var(--luna-primary-blue)"></i>
                        <span>订单查询</span>
                    </div>
                    
                    <div class="card-body">
                        <p class="text-info text-center fw-bold my-3">
                            通过联系方式和查单密码查询历史订单
                        </p>
                        
                        <form action="javascript:void(0);" id="search-form" class="p-3">
                            <div class="mb-3">
                                <label for="contact-input" class="form-label">联系方式:</label>
                                <input type="text" class="form-control" name="contact" id="contact-input" required placeholder="邮箱/QQ/手机号等">
                            </div>
                            <div class="mb-3">
                                <label for="password-input" class="form-label">查单密码:</label>
                                <input type="password" class="form-control" name="query_password" id="password-input" required placeholder="请输入您的查单密码">
                            </div>
                            
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary" id="search-btn">
                                    <span>立即查询</span>
                                </button>
                            </div>
                        </form>
                        
                        <div id="order-list-area" class="mt-4">
                            <p class="text-muted text-center">点击上方按钮查询订单</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="query-m d-block d-md-none">
        <a href="index.html">
            <i class="fas fa-home"></i>
            <span>返回首页</span>
        </a>
    </div>

    <script src="/assets/jquery-3.6.0.min.js"></script>
    <script src="/assets/bootstrap.bundle.min.js"></script>
    <script src="/themes/default/files/header.js"></script> <script src="/themes/default/files/footer.js"></script> <script src="/themes/default/files/main-default-bs.js"></script>
    <script>
        // --- Order Search Specific JS ---
        $(document).ready(function() {
            // Restore saved inputs
            $('#contact-input').val(localStorage.getItem('userContact') || '');
            $('#password-input').val(localStorage.getItem('userPassword') || '');

            // Form submission logic
            $('#search-form').on('submit', function(e) {
                e.preventDefault();
                const btn = $('#search-btn span');
                btn.text('查询中...');
                
                const payload = {
                    contact: $('#contact-input').val(),
                    query_password: $('#password-input').val()
                };

                // Cache search info
                localStorage.setItem('userContact', payload.contact);
                localStorage.setItem('userPassword', payload.query_password);

                $.ajax({
                    url: '/api/shop/orders/query',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (orders) {
                        renderOrderTable(orders, payload);
                        btn.text('立即查询');
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.error || '查询失败，请检查信息是否正确。';
                        alert(errorMsg);
                        $('#order-list-area').html('<p class="text-danger text-center">' + errorMsg + '</p>');
                        btn.text('立即查询');
                    }
                });
            });

            // Delete order handler
            $(document).on('click', '.btn-delete-order', function() {
                if (!confirm('确定要删除此未支付订单吗？')) return;

                const orderId = $(this).data('id');
                const btn = $(this);
                btn.attr('disabled', true).text('删除中...');

                const payload = {
                    id: orderId,
                    contact: $('#contact-input').val(),
                    query_password: $('#password-input').val()
                };

                $.ajax({
                    url: '/api/shop/order/delete',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function() {
                        alert('订单删除成功！');
                        $('#search-form').trigger('submit'); // Refresh list
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.error || '删除失败。';
                        alert(errorMsg);
                        btn.attr('disabled', false).text('删除');
                    }
                });
            });
            
            // View Cards handler (Simplified: directs to pay.html to show cards/status)
            $(document).on('click', '.btn-view-cards', function() {
                const orderId = $(this).data('id');
                // Redirect to pay page. The pay page's status poller will immediately show the cards.
                window.location.href = `pay.html?order_id=${orderId}`;
            });


            // --- Render Order Table ---
            const renderOrderTable = (orders, searchInfo) => {
                const container = $('#order-list-area');
                if (!orders || orders.length === 0) {
                    container.html('<p class="text-muted text-center">未找到相关订单</p>');
                    return;
                }
                
                let tableHtml = `
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="bg-light">
                                <tr>
                                    <th>订单号/商品</th>
                                    <th>金额</th>
                                    <th>状态/时间</th>
                                    <th>操作</th>
                                </tr> 
                            </thead>
                            <tbody>
                `;

                orders.forEach(order => {
                    const statusClass = order.status === 0 ? 'warning' : order.status === 1 ? 'info' : 'success';
                    const statusText = order.status === 0 ? '待支付' : order.status === 1 ? '已支付/待发货' : '已完成';
                    
                    let actionButtons = '';
                    if (order.status === 0) {
                        actionButtons += `<a href="pay.html?order_id=${order.id}" class="btn btn-sm btn-primary">去支付</a>`;
                        actionButtons += `<button type="button" data-id="${order.id}" class="btn btn-sm btn-danger btn-delete-order ms-1">删除</button>`;
                    } else if (order.status >= 1) {
                        actionButtons += `<a href="pay.html?order_id=${order.id}" class="btn btn-sm btn-info btn-view-cards">查看卡密</a>`;
                    }

                    tableHtml += `
                        <tr>
                            <td class="small">
                                <strong>${order.id}</strong>
                                <div class="text-muted">${order.product_name} - ${order.variant_name}</div>
                            </td>
                            <td>¥${order.total_amount}</td>
                            <td>
                                <span class="status-badge bg-${statusClass}">${statusText}</span>
                                <div class="small text-muted mt-1">${order.created_at_str}</div>
                            </td>
                            <td>${actionButtons}</td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table></div>';
                container.html(tableHtml);
            };
        });
    </script>
</body>
</html>

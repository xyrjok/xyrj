<div contenteditable="true" translate="no" class="ProseMirror"><h1>Cloudflare Worker Serverless 发卡系统 (MPA版)</h1><p>这是一个完全基于 Cloudflare 生态系统（Pages + Workers + D1）构建的轻量级、无服务器（Serverless）数字商品自动发卡系统。</p><p>它采用多页应用 (MPA) 架构，前端为纯静态 HTML/JS/Bootstrap 5，后端由 Cloudflare Worker 处理核心逻辑，数据库使用 Cloudflare D1。</p><blockquote><p><strong>核心优势</strong>：无需购买服务器，无需备案，完全免费（在 Cloudflare 免费额度内），且支持在浏览器中完成所有部署操作。</p></blockquote><h2>✨ 主要特性</h2><ul><li><p><strong>无需服务器</strong>: 依托 Cloudflare 全球边缘网络运行。</p></li><li><p><strong>低成本/免费</strong>: 利用 Cloudflare Workers 和 Pages 的免费额度。</p></li><li><p><strong>原生支付宝当面付</strong>: 集成 Web Crypto API，无需第三方挂机或网关，直接对接支付宝官方接口。</p></li><li><p><strong>多规格商品</strong>: 支持单一商品下设置不同价格、库存、图片的多种规格（如月卡、季卡）。</p></li><li><p><strong>MPA 主题架构</strong>: 结构清晰的多页应用模式，易于开发和切换前台主题。</p></li><li><p><strong>完善的后台管理</strong>:</p><ul><li><p>商品与分类管理</p></li><li><p>卡密批量导入与导出</p></li><li><p>订单状态查询与补单</p></li><li><p>文章/公告发布系统</p></li><li><p>支付接口在线配置</p></li></ul></li></ul><h2>📂 项目结构</h2><pre><code>xyrj-faka/
├── _worker.js              # [核心] 后端逻辑、路由重写、API接口
├── schema.sql              # [核心] D1 数据库初始化脚本
├── config.js               # 前端全局配置文件
├── README.md               # 项目说明文档
├── admin/                  # 后台管理界面 (Bootstrap 5)
│   ├── index.html          # 登录页
│   ├── dashboard.html      # 仪表盘
│   ├── products.html       # 商品管理
│   └── ...
└── themes/                 # 前台主题文件夹
    └── default/            # 默认主题
        ├── index.html      # 首页
        ├── product.html    # 商品详情页
        ├── pay.html        # 支付页
        └── assets/         # 主题静态资源 (css/js/img)
<br class="ProseMirror-trailingBreak"></code></pre><h2>🚀 浏览器部署指南 (零本地环境)</h2><p>只需一个 GitHub 账号和一个 Cloudflare 账号，即可在浏览器中完成部署。</p><h3>第一步：准备 GitHub 仓库</h3><ol><li><p>Fork 本仓库，或者创建一个新的私有仓库，将所有文件上传上去。</p></li></ol><h3>第二步：创建并初始化 D1 数据库</h3><ol><li><p>登录 Cloudflare Dashboard。</p></li><li><p>进入 <strong>Workers &amp; Pages</strong> -&gt; <strong>D1</strong>。</p></li><li><p>点击 <strong>Create database</strong>，创建一个新数据库（例如命名为 <code>xyrj_db</code>）。</p></li><li><p>进入刚创建的数据库，点击 <strong>Console</strong> (控制台) 标签。</p></li><li><p>复制 <code>schema.sql</code> 文件中的<strong>所有</strong>内容。</p></li><li><p>粘贴到 Console 中并点击 <strong>Execute</strong> (执行)。</p><ul><li><p><em>验证：执行成功后，你应该能看到 <code>products</code>, <code>orders</code>, <code>site_config</code> 等 8 张表。</em></p></li></ul></li></ol><h3>第三步：创建 Cloudflare Pages 项目</h3><ol><li><p>进入 <strong>Workers &amp; Pages</strong> -&gt; <strong>Overview</strong> -&gt; <strong>Create application</strong> -&gt; <strong>Pages</strong> -&gt; <strong>Connect</strong> to<strong> Git</strong>。</p></li><li><p>选择你刚才上传的 GitHub 仓库。</p></li><li><p><strong>配置构建设置 (关键)</strong>：</p><ul><li><p><strong>Project name</strong>: 自定义你的项目名（如 <code>xyrj-shop</code>）。</p></li><li><p><strong>Production branch</strong>: <code>main</code> (或你实际使用的分支)。</p></li><li><p><strong>Framework preset</strong>: 选择 <strong>None</strong>。</p></li><li><p><strong>Build command</strong>: <strong>留空</strong>。</p></li><li><p><strong>Build</strong> output<strong> directory</strong>: 填入 <code>/</code> (或者留空)。</p></li></ul></li><li><p>先<strong>不要</strong>点击部署，继续看下一步。</p></li></ol><h3>第四步：配置环境变量与数据库绑定 (最关键)</h3><p>在部署界面的下方（或部署完成后进入 Settings -&gt; Functions）：</p><ol><li><p><strong>环境变量 (Environment variables)</strong>：
添加以下 3 个变量用于后台管理员登录：</p><ul><li><p><code>ADMIN_USER</code>: 设置你的后台用户名 (如 <code>admin</code>)</p></li><li><p><code>ADMIN_PASS</code>: 设置你的后台密码 (如 <code>password123</code>)</p></li><li><p><code>ADMIN_TOKEN</code>: 设置一个复杂的 API 密钥 (如 <code>sk_live_xxxxxxxx</code>)</p></li></ul></li><li><p><strong>D1 数据库绑定 (D1 database bindings)</strong>：</p><ul><li><p><em>注意：如果首次部署界面没有此选项，可先点击“Save</em> and Deploy”让其失败一次，然后进入项目设置的 <code>Settings</code> -&gt;<em> <code>Functions</code> 中添加。</em></p></li><li><p><strong>Variable name</strong>: 必须填写 <code>MY_XYRJ</code> (与 <code>_worker.js</code> 代码一致，区分大小写)。</p></li><li><p><strong>D1 database</strong>: 选择第二步中创建的数据库 (如 <code>xyrj_db</code>)。</p></li></ul></li></ol><h3>第五步：上线</h3><ol><li><p>配置完成后，如果之前没部署成功，请进入 <strong>Deployments</strong> 标签页，点击最新的部署右侧的三个点，选择 <strong>Retry deployment</strong>。</p></li><li><p>等待部署完成后，访问 Cloudflare 分配的 <code>xxx.pages.dev</code> 域名即可看到网站。</p></li></ol><h2>⚙️ 配置与使用</h2><h3>后台管理</h3><ul><li><p>后台地址：<code>https://你的域名.pages.dev/admin/</code></p></li><li><p>使用你在环境变量中设置的 <code>ADMIN_USER</code> 和 <code>ADMIN_PASS</code> 登录。</p></li></ul><h3>配置支付宝当面付</h3><ol><li><p>登录后台，进入“支付设置”。</p></li><li><p>选择“支付宝当面付”，填入：</p><ul><li><p><strong>AppID</strong>: 你的支付宝应用的 AppID。</p></li><li><p><strong>应用私钥</strong>: PKCS8 格式的私钥（建议去除首尾的 <code>-----BEGIN...</code> 和换行符，填入一行长字符串）。</p></li></ul></li><li><p>在支付宝商家平台，将<strong>授权回调地址</strong>和<strong>应用网关</strong>设置为：<code>https://你的域名.pages.dev/api/notify/alipay</code>。</p></li></ol><h3>切换或修改主题</h3><ul><li><p>默认主题位于 <code>/themes/default/</code>。</p></li><li><p>如需修改页面，直接在 GitHub 上编辑对应的 HTML 文件即可，Cloudflare Pages 会自动重新部署。</p></li><li><p>MPA 架构下，Worker 会自动将根目录 <code>/</code> 的访问路由到 <code>/themes/default/index.html</code>。</p></li></ul><h2>🛠️ 本地开发 (可选)</h2><p>如果你有本地开发环境，可以使用官方的 <code>wrangler</code> 命令行工具进行调试</p></div>
